<%- include partials/head.ejs %>
<%- include partials/navbar.ejs %>
<link rel="stylesheet" type="text/css" href="../../styles/search_result.css">
<script src="https://maps.googleapis.com/maps/api/js"></script>

<div id="customMap" class="custommap"></div>
<div class="container">
    <div class="row details-side">
        <div class="col-xs-6 col-sm-6 col-md-6">
            <div class="row">
                <h3><%= city %></h3>
                <form id="favorite_form" name="favorite_form" method="post" action="/users/favorite">
                    <input type="hidden" name="city" value= <%= city%> />
                    <input type="hidden" name="city_population" value= <%= details.Population_2016%> />
                    <input type="hidden" name="earnings" value= <%= details.Average_Weekly_Workplace_Earnings_2017%> />
                    <button class="favorite"></button>
                </form>
                <span id="interestedin_form">
                <button class="pin" data-value= <%= city%> ></button>
              </span>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <p><span>Population: </span> <%= details.Population_2016%> </p>
                <p><span>UK Population: </span> <%= details.Population_UK %></p>
                <p><span>Non-UK Population </span> <%= details['Population_Non-UK'] %></p>
                <p><span>CO2 emissions/capita: </span> <%= details.CO2_Emissions_per_Capita_2015_tons %> tons </p>
                <p><span>Ultrafast broadband 2017: </span><%= details.Ultrafast_Broadband_2017 %> </p>
                <p><span>Public libraries </span> <%= details.Public_libraries %></p>                
                <p><span>Employment rate: </span> <%= details.Employment_Rate_2017 %> </p>
                <p><span>Ratio of private/public sector employment: </span> <%= details.Ratio_of_Private_to_Public_Sector_Employment_2016 %></p>
                <p><span>Average weekly workplace earnings: </span>  Â£ <%= details.Average_Weekly_Workplace_Earnings_2017 %></p>
                <p><span>Housing affordability ratio: </span> <%= details.Housing_Affordability_Ratio_2017 %></p> 
              </div>
            </div>
       </div>

       <div class="col-xs-6 col-sm-6 col-md-6">
        <h3>Reviews</h3>
            <div></div>
            <div>
                <form id="review_form"  name="review_form" method="post" action="/cities/reviews">
                  <input type="hidden" name="city" value= <%= city%> />
                  <!-- TODO display average rating here -->
                  <div class="form-group rating-group">
                    <fieldset class="rating">
                      <input type="radio" id="star5" name="rating" value="5" /><label class = "full" for="star5" title="Awesome - 5 stars"></label>
                      <input type="radio" id="star4half" name="rating" value="4.5" /><label class="half" for="star4half" title="Pretty good - 4.5 stars"></label>
                      <input type="radio" id="star4" name="rating" value="4" /><label class="full" for="star4" title="Pretty good - 4 stars"></label>
                      <input type="radio" id="star3half" name="rating" value="3.5" /><label class="half" for="star3half" title="OK - 3.5 stars"></label>
                      <input type="radio" id="star3" name="rating" value="3" /><label class = "full" for="star3" title="OK - 3 stars"></label>
                      <input type="radio" id="star2half" name="rating" value="2.5" /><label class="half" for="star2half" title="Kinda bad - 2.5 stars"></label>
                      <input type="radio" id="star2" name="rating" value="2" /><label class = "full" for="star2" title="Kinda bad - 2 stars"></label>
                      <input type="radio" id="star1half" name="rating" value="1.5" /><label class="half" for="star1half" title="Meh - 1.5 stars"></label>
                      <input type="radio" id="star1" name="rating" value="1" /><label class = "full" for="star1" title="Bad - 1 star"></label>
                      <input type="radio" id="starhalf" name="rating" value="0.5" /><label class="half" for="starhalf" title="Very bad - 0.5 stars"></label>
                    </fieldset>
                  </div>
                    <div class="form-group">
                        <input type="text" id="title-input" class="form-control" name="review_title" placeholder="Review Title" autofocus="">
                    </div>
                    <div class="form-group">
                        <textarea placeholder="Your Review" id="body-input" class="form-control" rows="6" name="review_body"></textarea>
                    </div>
                    <div class="form-group">
                      <input type="submit" class=" btn submit-button submit_review" value="Submit">
                    </div>
                </form>
            </div>
            <div>
            <!-- TODO display reviews here
              
            -->  
            </div>
            
       </div>
   </div>
</div>
<script type="text/javascript">
  function initialize() {
      var mapOptions = { center: location, zoom: 14 }
      var map = new google.maps.Map(document.getElementById('customMap'),mapOptions);
      var location = new google.maps.Geocoder().geocode({
        'address': '<%= city %>'
      },
      function(results, status) {
          if(status == google.maps.GeocoderStatus.OK) {
             new google.maps.Marker({
                position: results[0].geometry.location,
                map: map
             });
             map.setCenter(results[0].geometry.location);
          }
       });

      var styles = [
          { "featureType": "landscape", "stylers": [ { "color": "#b1babf" } ] },
          { "featureType": "water", "stylers": [ { "color": "#4d6a79" } ] },
          { "featureType": "poi.business", "stylers": [ { "color": "#5a7093" } ] }
      ]
      map.setOptions({styles: styles})
  }

  google.maps.event.addDomListener(window, 'load', initialize)

  function SubForm (){
    $.ajax({
        url:'/users/favorite',
        type:'post',
        data:$('#favorite_form').serialize(),
        success:function(){
          alert("city added to favorites");
        }
    });
  }

  function pinCity(city) {
    var data = {};
    data.city = city;
    console.log("data pin is " + JSON.stringify(data));
    $.ajax({
      url: '/users/interestedin',
      type: 'post',
      data: JSON.stringify(data),
      contentType: 'application/json',
      success: function() {
        console.log("pinned");
      }
    });
  }

  function submitReview(city, title, body, rating){
    var data = {};
    data.cityName = city;
    data.reviewTitle = title;
    data.reviewBody = body;
    data.reviewRating = rating;
    console.log("review data is " + JSON.stringify(data));
    $.ajax({
      url:'/cities/reviews',
      type:'post',
      data: JSON.stringify(data),
      contentType: 'application/json',
      success:function(){
          alert("review submitted");
        }
    });
  }
  
  //todo: function unpinCity(city) {}
  $('#interestedin_form .pin').on('click', function() {
    pinCity($(this).attr('data-value'))
  });

  $('#review_form .submit-button').on('click', function() {
    submitReview( 
        $(this).attr('data-value'), 
        $('#title-input').text(),
        $('#body-input').text(),
        $('input:radio[name=rating]:checked').val()
      )
  });
   

</script>
